name: Daily Product Ops Report

on:
  schedule:
    # 8:00 AM EST (UTC-5). DST note: change to '0 12 * * *' from mid-Mar to early-Nov for 8 AM EDT
    - cron: '0 13 * * *'
  workflow_dispatch:  # Allow manual trigger from GitHub UI

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install cryptography

      - name: Copy service account key
        # The SA JSON is stored as a GitHub Secret (base64-encoded)
        run: |
          echo "${{ secrets.GOOGLE_SA_JSON_B64 }}" | base64 -d > product-ops-agent-sa.json
        continue-on-error: true  # Don't fail if secret not set

      - name: Generate report
        env:
          LINEAR_API_KEY:  ${{ secrets.LINEAR_API_KEY }}
          GOOGLE_API_KEY:  ${{ secrets.GOOGLE_API_KEY }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SA_JSON:  product-ops-agent-sa.json
        run: python scripts/run_all.py

      - name: Send report to Slack
        uses: slackapi/slack-github-action@v2
        with:
          method: files.uploadV2
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: "U023R9B6K1B"
            initial_comment: "ðŸ“Š Daily Product Ops Report is ready!"
            file: "./public/index.html"
            filename: "product-ops-report.html"
